<html>
<head>
	<title>Diashow</title>

	<script type="text/javascript" src="jquery-1.8.3.min.js"></script>
	<script type="text/javascript" src="jquery.qrcode-0.2.min.js"></script>

	<link rel="stylesheet" type="text/css" href="style.css">

	<script type="text/javascript">

	var window_size_changed = function() {
		console.log("resize");
		var w = $(window).width();
		var h = $(window).height();
		if ( w > h){
			$('.image .picture').css('width', w);
			$('.image .picture').css('height', undefined);
		} else {
			$('.image .picture').css('width', undefined);
			$('.image .picture').css('height', h);
		}
		$('.image').css('width', w);
		$('.image').css('height', h);

		$('.info_footer').css('width', w);
		$('.info_footer').css('height', 200);
		$('.info_footer').css('top', h - 200);
	}

	$(window).resize( window_size_changed );

	$(document).ready(function() {

		window_size_changed();

		var images = []
		var qr_codes = []
		var image_index = 1;
		var B_visible = false;
		var fading_duration = 1000;
		var picture_visible_duration = 5000;
		var image_list_update_interval = 30000;

		var update_image_list = function() {
			$.getJSON('cgi-bin/images_list.py', function(data){
				var new_images = [];
				var new_qr_codes = [];
				for (var i = 0; i < data.length; i++){
					new_images.push(data[i]['image']);
					new_qr_codes.push(data[i]['qrcode']);
				}
				images = new_images;
				qr_codes = new_qr_codes;

				console.log("got new image list: " + new_images);
				console.log("got new qrcode list: " + qr_codes);
				setTimeout(update_image_list, image_list_update_interval);
			});
		}

		var load_next = function(B_visible) {
			image_index = (image_index +1) % images.length;
			var image_src = images[image_index];
			var qr_code_src = qr_codes[image_index];

			console.log("loading: " + image_src);

			if(B_visible){
				$('#A .picture').attr('src', image_src);
				$('#A .qr_code').attr('src', qr_code_src);
			} else {
				$('#B .picture').attr('src', image_src);
				$('#B .qr_code').attr('src', qr_code_src);
			}
		}

		var switchImages = function() {
			// console.log("switching image");
			$('#B').fadeToggle(fading_duration, function(){
				B_visible = !B_visible;
				load_next(B_visible);
				setTimeout(switchImages, picture_visible_duration);
			});
		}

		console.log("initial image load");
		switchImages();
		update_image_list();

	});
	

	</script>

</head>
<body>
	<!-- <div id="presenter"/> -->

	<div id="A" class="image">
		<img class="picture" src='resources/loading01.jpg'>

		<div class="info_footer">
			<img class="qr_code"/>
			<span>
				Scan to download.
			</span>
		</div>

	</div>

	<div id="B" class="image">
		<img class="picture" src="resources/loading02.png">

		<div class="info_footer">
			<img class="qr_code"/>
			<span>
				Scan to download.
			</span>
		</div>
	</div>

</body>
</html>